'use strict';

var chunkG7VPYZGL_cjs = require('./chunk-G7VPYZGL.cjs');
var reactHooksAsync = require('@chengsokdara/react-hooks-async');
var react = require('react');

var fe={apiKey:"",autoStart:!1,autoTranscribe:!0,mode:"transcriptions",nonStop:!1,removeSilence:!1,stopTimeout:5e3,streaming:!1,timeSlice:1e3,onDataAvailable:void 0,onTranscribe:void 0},de={stop:void 0},le={blob:void 0,text:void 0},F=async(w,f)=>{let y=await(await fetch(w)).blob(),u=new Blob([y],{type:f});return URL.createObjectURL(u)},me=async(w,f,m)=>{let u=await(await fetch(w)).text();m&&(u=m(u));let S=new Blob([u],{type:f});return URL.createObjectURL(S)},he=w=>{let{apiKey:f,autoStart:m,autoTranscribe:y,mode:u,nonStop:S,removeSilence:O,stopTimeout:K,streaming:U,timeSlice:z,whisperConfig:d,onDataAvailable:G,onTranscribe:L}={...fe,...w};if(!f&&!L)throw new Error("apiKey is required if onTranscribe is not provided");let h=react.useRef([]),s=react.useRef(),c=react.useRef(),r=react.useRef(),a=react.useRef(),R=react.useRef(de),[J,v]=react.useState(!1),[N,A]=react.useState(!1),[Q,g]=react.useState(!1),[C,T]=react.useState(le),[V,X]=react.useState(!1),W=react.useRef(),[E,Y]=react.useState(!1),Z=async()=>{let e="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd",t=await me(`${e}/ffmpeg.js`,"text/javascript",i=>i.replace("new URL(e.p+e.u(814),e.b)","s.workerURL")),n="https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd",o={workerURL:await F(`${e}/814.ffmpeg.js`,"text/javascript"),coreURL:await F(`${n}/ffmpeg-core.js`,"text/javascript"),wasmURL:await F(`${n}/ffmpeg-core.wasm`,"application/wasm")};import(t).then(async i=>{let p=new i.FFmpeg;W.current=p,p.on("log",({message:ge})=>{}),await p.load(o),Y(!0);});};react.useEffect(()=>()=>{h.current&&(h.current=[]),s.current&&(s.current.flush(),s.current=void 0),r.current&&(r.current.destroy(),r.current=void 0),k("stop"),c.current&&(c.current.off("speaking",B),c.current.off("stopped_speaking",x)),a.current&&(a.current.getTracks().forEach(e=>e.stop()),a.current=void 0);},[]),reactHooksAsync.useEffectAsync(async()=>{m&&await j();},[m]);let ee=async()=>{await j();},te=async()=>{await ae();},re=async()=>{await H();},ne=async()=>{await I();},j=async()=>{try{if(E||Z(),a.current||await oe(),a.current){if(!r.current){let{default:{RecordRTCPromisesHandler:t,StereoAudioRecorder:n}}=await import('recordrtc'),o={mimeType:"audio/wav",numberOfAudioChannels:1,recorderType:n,sampleRate:44100,timeSlice:U?z:void 0,type:"audio",ondataavailable:y&&U?ie:void 0};r.current=new t(a.current,o);}if(!s.current){let{Mp3Encoder:t}=await import('lamejs');s.current=new t(1,44100,96);}let e=await r.current.getState();(e==="inactive"||e==="stopped")&&await r.current.startRecording(),e==="paused"&&await r.current.resumeRecording(),S&&D("stop"),v(!0);}}catch{}},oe=async()=>{try{if(a.current&&a.current.getTracks().forEach(e=>e.stop()),a.current=await navigator.mediaDevices.getUserMedia({audio:!0}),!c.current){let{default:e}=await import('hark');c.current=e(a.current,{interval:100,play:!1}),c.current.on("speaking",B),c.current.on("stopped_speaking",x);}}catch{}},D=e=>{R.current[e]||(R.current[e]=setTimeout(H,K));},B=()=>{A(!0),k("stop");},x=()=>{A(!1),S&&D("stop");},ae=async()=>{try{r.current&&(await r.current.getState()==="recording"&&await r.current.pauseRecording(),k("stop"),v(!1));}catch{}},H=async()=>{try{if(r.current){let e=await r.current.getState();if((e==="recording"||e==="paused")&&await r.current.stopRecording(),se(),k("stop"),v(!1),y)await I();else {let t=await r.current.getBlob();T({blob:t});}await r.current.destroy(),h.current=[],s.current&&(s.current.flush(),s.current=void 0),r.current=void 0;}}catch{}},se=()=>{c.current&&(c.current.off("speaking",B),c.current.off("stopped_speaking",x),c.current=void 0),a.current&&(a.current.getTracks().forEach(e=>e.stop()),a.current=void 0);},k=e=>{R.current[e]&&(clearTimeout(R.current[e]),R.current[e]=void 0);},_=async e=>{if(typeof L=="function"){let t=await L(e);T(t);}else {let t=new File([e],"speech.mp3",{type:"audio/mpeg"}),n=await P(t);T({blob:e,text:n}),n===void 0&&X(!0);}},I=async()=>{try{if(s.current&&r.current){if(await r.current.getState()==="stopped"){g(!0);let t=await r.current.getBlob();if(O&&E){let n=await t.arrayBuffer(),o=W.current;if(o){await o.writeFile("in.wav",new Uint8Array(n)),await o.exec(["-i","in.wav","-acodec","libmp3lame","-b:a","96k","-ar","44100","-af",chunkG7VPYZGL_cjs.b,"out.mp3"]);let p=await o.readFile("out.mp3");if(p.length<=358){T({blob:t}),g(!1);return}t=new Blob([p.buffer],{type:"audio/mpeg"});}}else {let n=await t.arrayBuffer(),o=s.current.encodeBuffer(new Int16Array(n));t=new Blob([o],{type:"audio/mpeg"});}await _(t),g(!1);}}else {let{blob:e}=C;e&&(g(!0),await _(e),g(!1));}}catch{g(!1);}},ie=async e=>{try{if(U&&r.current){if(G?.(e),s.current){let n=await e.arrayBuffer(),o=s.current.encodeBuffer(new Int16Array(n)),i=new Blob([o],{type:"audio/mpeg"});h.current.push(i);}if(await r.current.getState()==="recording"){let n=new Blob(h.current,{type:"audio/mpeg"}),o=new File([n],"speech.mp3",{type:"audio/mpeg"}),i=await P(o);i&&T(p=>({...p,text:i}));}}}catch{}},P=reactHooksAsync.useMemoAsync(async e=>{let t=new FormData;t.append("file",e),t.append("model","whisper-1"),u==="transcriptions"&&t.append("language",d?.language??"en"),d?.prompt&&t.append("prompt",d.prompt),d?.response_format&&t.append("response_format",d.response_format),d?.temperature&&t.append("temperature",`${d.temperature}`);let n={};n["Content-Type"]="multipart/form-data",f&&(n.Authorization=`Bearer ${f}`);let{default:o}=await import('axios'),{default:i}=await import('axios-retry');i(o,{retries:3,retryDelay:i.exponentialDelay});try{return (await o.post(chunkG7VPYZGL_cjs.c+u,t,{headers:n})).data.text}catch{return}},[f,u,d]);return {recording:J,speaking:N,transcribing:Q,transcript:C,isTranscribingError:V,pauseRecording:te,startRecording:ee,stopRecording:re,startTranscribing:ne}};

exports.a = he;
